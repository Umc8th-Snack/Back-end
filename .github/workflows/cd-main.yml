name: CD on main (spring+python → prod)

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

permissions:
  id-token: write
  contents: read

jobs:
  build_and_push:
    runs-on: ubuntu-latest
    env:
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
      AWS_REGION:     ${{ secrets.AWS_REGION }}
      SPRING_REPO:    spring
      PY_REPO:        python-nlp
      ENV_TAG:        prod-latest
    steps:
      - uses: actions/checkout@v4

      # ---------------- AWS ----------------
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume:    ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region:        ${{ secrets.AWS_REGION }}
          role-session-name: snacknews-cd

      - uses: aws-actions/amazon-ecr-login@v2

      # ---------------- 스프링 빌드 ----------------
      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Build Spring JAR
        run: |
          chmod +x ./gradlew
          ./gradlew clean bootJar -x test
          ls -la build/libs

      # ---------------- Docker Build & Push ----------------
      - name: Build & Push Spring Image
        run: |
          URI=${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${SPRING_REPO}
          docker build -f src/Dockerfile -t ${URI}:${{ github.sha }} -t ${URI}:${ENV_TAG} .
          docker push ${URI}:${{ github.sha }}
          docker push ${URI}:${ENV_TAG}

      - name: Build & Push Python NLP Image
        run: |
          URI=${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${PY_REPO}
          docker build -t ${URI}:${{ github.sha }} -t ${URI}:${ENV_TAG} ./python-nlp-service
          docker push ${URI}:${{ github.sha }}
          docker push ${URI}:${ENV_TAG}

  deploy:
    runs-on: ubuntu-latest
    needs: build_and_push
    env:
      REMOTE_DIR: /home/ubuntu/Back-end
      ENV_TAG: prod-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host:     ${{ secrets.SSH_HOST_STG }}
          username: ${{ secrets.SSH_USER }}
          key:      ${{ secrets.SSH_PRIVATE_KEY }}
          script_stop: true
          script: |
            set -e
            cd "${{ env.REMOTE_DIR }}"

            AWS_REGION="${{ secrets.AWS_REGION }}"
            AWS_ACCOUNT_ID="${{ secrets.AWS_ACCOUNT_ID }}"
            TAG="${{ env.ENV_TAG }}"

            # Login to ECR
            aws ecr get-login-password --region "$AWS_REGION" \
              | docker login --username AWS --password-stdin "$AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com"

            # Update tag environment file
            echo "IMAGE_TAG=$TAG" > .deploy.env
            echo "PYTHON_IMAGE_TAG=$TAG" >> .deploy.env

            # Pull & restart
            docker compose --env-file .deploy.env pull
            docker compose --env-file .deploy.env up -d

            docker image prune -f
